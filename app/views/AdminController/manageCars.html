#{extends 'main.html' /}
#{set title:'Gestion de Coches - Admin BYCar' /}

<div class="admin-container">
    <!-- Sidebar de navegación admin -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <div class="admin-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Panel Admin</span>
            </div>
        </div>
        <nav class="admin-nav">
            <a href="@{AdminController.dashboard()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Dashboard
            </a>
            <a href="@{AdminController.manageCars()}" class="admin-nav-link active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.5 2.8c0 .1-.1.2-.1.3V15c0 .6.4 1 1 1h2"/>
                    <circle cx="7" cy="17" r="2"/>
                    <path d="M9 17h6"/>
                    <circle cx="17" cy="17" r="2"/>
                </svg>
                Coches
            </a>
            <a href="@{AdminController.manageOrders()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                Pedidos
            </a>
            <a href="@{AdminController.manageUsers()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Usuarios
            </a>
        </nav>
        <div class="admin-sidebar-footer">
            <a href="@{Application.index()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Volver al Sitio
            </a>
        </div>
    </aside>

    <!-- Contenido principal -->
    <main class="admin-content">
        <div class="admin-header">
            <h1>Gestion de Coches</h1>
            <p class="admin-subtitle">Administra el catalogo de vehiculos (${cars.size()} vehiculos)</p>
        </div>

        #{if flash.success}
            <div class="alert-admin alert-success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                ${flash.success}
            </div>
        #{/if}

        #{if flash.error}
            <div class="alert-admin alert-error">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                ${flash.error}
            </div>
        #{/if}

        <!-- Acciones -->
        <div class="admin-actions">
            <a href="@{AdminController.newCar()}" class="btn-admin-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Nuevo Coche
            </a>
        </div>

        <!-- Filtros -->
        <div class="filters-bar">
            <form action="@{AdminController.manageCars()}" method="GET" class="filters-form">
                <div class="filter-group">
                    <label>Marca</label>
                    <select name="filterMarca" class="filter-select">
                        <option value="">Todas</option>
                        #{list items:marcas, as:'marca'}
                            <option value="${marca}" #{if filterMarca == marca}selected#{/if}>${marca}</option>
                        #{/list}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Buscar Modelo</label>
                    <input type="text" name="searchModelo" class="filter-input" placeholder="Ej: Serie 3..." value="${searchModelo}">
                </div>
                <div class="filter-group">
                    <label>Ordenar por</label>
                    <select name="sortBy" class="filter-select">
                        <option value="marca_az" #{if sortBy == 'marca_az' || !sortBy}selected#{/if}>Marca (A-Z)</option>
                        <option value="precio_asc" #{if sortBy == 'precio_asc'}selected#{/if}>Precio (menor a mayor)</option>
                        <option value="precio_desc" #{if sortBy == 'precio_desc'}selected#{/if}>Precio (mayor a menor)</option>
                        <option value="year_desc" #{if sortBy == 'year_desc'}selected#{/if}>Año (mas reciente)</option>
                        <option value="year_asc" #{if sortBy == 'year_asc'}selected#{/if}>Año (mas antiguo)</option>
                    </select>
                </div>
                <button type="submit" class="btn-filter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    Filtrar
                </button>
                #{if filterMarca || searchModelo || (sortBy && sortBy != 'marca_az')}
                    <a href="@{AdminController.manageCars()}" class="btn-clear-filters">Limpiar</a>
                #{/if}
            </form>
        </div>

        <!-- Tabla de coches -->
        <div class="dashboard-section">
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Imagen</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Version</th>
                            <th>Ano</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        #{list items:cars, as:'car'}
                            <tr>
                                <td><span class="order-id">#${car.id}</span></td>
                                <td>
                                    <div class="table-car-image">
                                        <img src="${car.foto1}" alt="${car.marca} ${car.modelo}">
                                    </div>
                                </td>
                                <td>${car.marca}</td>
                                <td><strong>${car.modelo}</strong></td>
                                <td>${car.version ?: '-'}</td>
                                <td>${car.year}</td>
                                <td class="price">${car.precio.format('###,###').replace(',', '.')} &euro;</td>
                                <td>
                                    <div class="table-actions">
                                        <a href="@{AdminController.editCar(car.id)}" class="btn-table-action" title="Editar">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </a>
                                        <a href="@{CarController.detail(car.id)}" class="btn-table-action" title="Ver en catalogo" target="_blank">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                <circle cx="12" cy="12" r="3"/>
                                            </svg>
                                        </a>
                                        <button type="button" class="btn-table-action btn-delete" title="Eliminar" onclick="showDeleteModal(${car.id}, '${car.marca}', '${car.modelo}')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"/>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        #{/list}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Formulario oculto para eliminar -->
<form id="deleteCarForm" action="" method="POST" style="display: none;"></form>

<!-- Modal de Confirmacion de Eliminacion -->
<div id="deleteModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
        <div class="confirm-modal-icon delete-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        </div>
        <h3 class="confirm-modal-title">Eliminar Vehiculo</h3>
        <p class="confirm-modal-text">
            ¿Eliminar <strong id="deleteCarName"></strong>?
        </p>
        <p class="confirm-modal-subtext">
            Esta accion no se puede deshacer.
        </p>
        <div class="confirm-modal-actions">
            <button type="button" class="btn-modal-cancel" onclick="hideDeleteModal()">
                Cancelar
            </button>
            <button type="button" class="btn-modal-delete" onclick="confirmDelete()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Eliminar
            </button>
        </div>
    </div>
</div>

<script>
    let deleteCarId = null;

    function showDeleteModal(carId, marca, modelo) {
        deleteCarId = carId;
        document.getElementById('deleteCarName').textContent = marca + ' ' + modelo;
        document.getElementById('deleteModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function hideDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        document.body.style.overflow = '';
        deleteCarId = null;
    }

    function confirmDelete() {
        if (deleteCarId) {
            const form = document.getElementById('deleteCarForm');
            form.action = '/admin/cars/delete/' + deleteCarId;
            form.submit();
        }
    }

    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideDeleteModal();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideDeleteModal();
        }
    });
</script>
