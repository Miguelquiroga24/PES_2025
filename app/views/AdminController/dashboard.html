#{extends 'main.html' /}
#{set title:'Dashboard Admin - BYCar' /}

<div class="admin-container">
    <!-- Sidebar de navegación admin -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <div class="admin-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Panel Admin</span>
            </div>
        </div>
        <nav class="admin-nav">
            <a href="@{AdminController.dashboard()}" class="admin-nav-link active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                </svg>
                Dashboard
            </a>
            <a href="@{AdminController.manageCars()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.5 2.8c0 .1-.1.2-.1.3V15c0 .6.4 1 1 1h2"/>
                    <circle cx="7" cy="17" r="2"/>
                    <path d="M9 17h6"/>
                    <circle cx="17" cy="17" r="2"/>
                </svg>
                Coches
            </a>
            <a href="@{AdminController.manageOrders()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                Pedidos
            </a>
            <a href="@{AdminController.manageUsers()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Usuarios
            </a>
        </nav>
        <div class="admin-sidebar-footer">
            <a href="@{Application.index()}" class="admin-nav-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Volver al Sitio
            </a>
        </div>
    </aside>

    <!-- Contenido principal -->
    <main class="admin-content">
        <div class="admin-header">
            <h1>Dashboard</h1>
            <p class="admin-subtitle">Resumen general del concesionario</p>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card kpi-ventas">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                </div>
                <div class="kpi-info">
                    <span class="kpi-value">${totalVentas?.format('###,###')?.replace(',', '.')} &euro;</span>
                    <span class="kpi-label">Total Ventas</span>
                </div>
            </div>

            <div class="kpi-card kpi-ordenes">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"/>
                        <circle cx="20" cy="21" r="1"/>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                </div>
                <div class="kpi-info">
                    <span class="kpi-value">${totalOrdenes}</span>
                    <span class="kpi-label">Total Pedidos</span>
                </div>
            </div>

            <div class="kpi-card kpi-clientes">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="kpi-info">
                    <span class="kpi-value">${totalClientes}</span>
                    <span class="kpi-label">Clientes</span>
                </div>
            </div>

            <div class="kpi-card kpi-coches">
                <div class="kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.5 2.8c0 .1-.1.2-.1.3V15c0 .6.4 1 1 1h2"/>
                        <circle cx="7" cy="17" r="2"/>
                        <path d="M9 17h6"/>
                        <circle cx="17" cy="17" r="2"/>
                    </svg>
                </div>
                <div class="kpi-info">
                    <span class="kpi-value">${totalCoches}</span>
                    <span class="kpi-label">Vehiculos</span>
                </div>
            </div>
        </div>

        <!-- Gráficas -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Ventas por Marca</h3>
                </div>
                <div class="chart-body">
                    <canvas id="ventasPorMarcaChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3>Ventas por Mes</h3>
                </div>
                <div class="chart-body">
                    <canvas id="ventasPorMesChart"></canvas>
                </div>
            </div>

            <div class="chart-container chart-small">
                <div class="chart-header">
                    <h3>Estados de Pedidos</h3>
                </div>
                <div class="chart-body chart-body-doughnut">
                    <canvas id="estadosPedidosChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Sección inferior: Órdenes y Top Coches -->
        <div class="dashboard-bottom-grid">
            <!-- Tabla de últimas órdenes -->
            <div class="dashboard-section">
                <div class="section-header-admin">
                    <h3>Ultimas Ordenes</h3>
                    <a href="@{AdminController.manageOrders()}" class="btn-link">Ver todas</a>
                </div>
                #{if ultimasOrdenes.isEmpty()}
                    <div class="empty-state">
                        <p>No hay ordenes registradas</p>
                    </div>
                #{/if}
                #{else}
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Vehiculo</th>
                                    <th>Precio</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                #{list items:ultimasOrdenes, as:'order'}
                                    <tr>
                                        <td><span class="order-id">#${order.id}</span></td>
                                        <td>${order.fullName}</td>
                                        <td>${order.car.marca} ${order.car.modelo}</td>
                                        <td class="price">${order.car.precio.format('###,###').replace(',', '.')} &euro;</td>
                                        <td>
                                            <span class="status-badge status-${order.estado}">
                                                #{if order.estado == 'pagado'}Pagado#{/if}
                                                #{if order.estado == 'pendiente_pago'}Pendiente#{/if}
                                                #{if order.estado == 'entregado'}Entregado#{/if}
                                                #{if order.estado == 'cancelado'}Cancelado#{/if}
                                            </span>
                                        </td>
                                        <td>${order.fechaCreacion.format('dd/MM/yyyy')}</td>
                                    </tr>
                                #{/list}
                            </tbody>
                        </table>
                    </div>
                #{/else}
            </div>

            <!-- Top coches vendidos -->
            <div class="dashboard-section">
                <div class="section-header-admin">
                    <h3>Top Vehiculos Vendidos</h3>
                </div>
                #{if cochesMasVendidos.isEmpty()}
                    <div class="empty-state">
                        <p>No hay ventas registradas</p>
                    </div>
                #{/if}
                #{else}
                    <div class="top-cars-list">
                        #{list items:cochesMasVendidos, as:'item'}
                            <div class="top-car-item">
                                <div class="top-car-rank">
                                    <span class="rank-number">${item_index + 1}</span>
                                </div>
                                <div class="top-car-image">
                                    <img src="${item.get('car').foto1}" alt="${item.get('car').marca} ${item.get('car').modelo}">
                                </div>
                                <div class="top-car-info">
                                    <span class="top-car-name">${item.get('car').marca} ${item.get('car').modelo}</span>
                                    <span class="top-car-price">${item.get('car').precio.format('###,###').replace(',', '.')} &euro;</span>
                                </div>
                                <div class="top-car-sales">
                                    <span class="sales-count">${item.get('ventas')}</span>
                                    <span class="sales-label">ventas</span>
                                </div>
                            </div>
                        #{/list}
                    </div>
                #{/else}
            </div>
        </div>
    </main>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Datos para gráficas desde el servidor
const ventasPorMarca = {
    #{list items:ventasPorMarca.keySet(), as:'marca'}
        "${marca}": ${ventasPorMarca.get(marca)}#{if !marca_isLast},#{/if}
    #{/list}
};

const ventasPorMes = {
    #{list items:ventasPorMes.keySet(), as:'mes'}
        "${mes}": ${ventasPorMes.get(mes)}#{if !mes_isLast},#{/if}
    #{/list}
};

const distribucionEstados = {
    #{list items:distribucionEstados.keySet(), as:'estado'}
        "${estado}": ${distribucionEstados.get(estado)}#{if !estado_isLast},#{/if}
    #{/list}
};

// Configuración global de Chart.js para tema oscuro
Chart.defaults.color = '#888888';
Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

// Gráfica de Ventas por Marca (Barras)
if (Object.keys(ventasPorMarca).length > 0) {
    const ctxMarcas = document.getElementById('ventasPorMarcaChart').getContext('2d');
    new Chart(ctxMarcas, {
        type: 'bar',
        data: {
            labels: Object.keys(ventasPorMarca),
            datasets: [{
                label: 'Ventas (€)',
                data: Object.values(ventasPorMarca),
                backgroundColor: 'rgba(212, 168, 83, 0.8)',
                borderColor: '#d4a853',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('de-DE') + ' €';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
} else {
    document.getElementById('ventasPorMarcaChart').parentElement.innerHTML = '<div class="chart-empty">Sin datos de ventas</div>';
}

// Gráfica de Ventas por Mes (Líneas)
const ctxMeses = document.getElementById('ventasPorMesChart').getContext('2d');
new Chart(ctxMeses, {
    type: 'line',
    data: {
        labels: Object.keys(ventasPorMes),
        datasets: [{
            label: 'Ventas (€)',
            data: Object.values(ventasPorMes),
            borderColor: '#0070f3',
            backgroundColor: 'rgba(0, 112, 243, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#0070f3',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                },
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('de-DE') + ' €';
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Gráfica de Estados (Doughnut)
if (Object.keys(distribucionEstados).length > 0) {
    const ctxEstados = document.getElementById('estadosPedidosChart').getContext('2d');
    new Chart(ctxEstados, {
        type: 'doughnut',
        data: {
            labels: Object.keys(distribucionEstados),
            datasets: [{
                data: Object.values(distribucionEstados),
                backgroundColor: [
                    '#f59e0b', // Pendiente - amarillo
                    '#10b981', // Pagado - verde
                    '#3b82f6', // Entregado - azul
                    '#ef4444'  // Cancelado - rojo
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                }
            },
            cutout: '65%'
        }
    });
} else {
    document.getElementById('estadosPedidosChart').parentElement.innerHTML = '<div class="chart-empty">Sin pedidos</div>';
}
</script>
